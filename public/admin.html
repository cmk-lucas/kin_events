<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Ajouter un Événement</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold mb-4">Ajouter un Événement</h1>
  <form id="eventForm" class="space-y-4" enctype="multipart/form-data" aria-labelledby="title">
    <label for="title" class="block">Titre :</label>
    <input id="title" type="text" placeholder="Titre" class="block w-full p-2 border rounded" required />
    <div id="titleError" class="text-red-500 text-sm hidden transition-all">Le titre est requis.</div>

    <label for="category" class="block">Catégorie :</label>
    <input id="category" type="text" placeholder="Catégorie" class="block w-full p-2 border rounded" required />
    <div id="categoryError" class="text-red-500 text-sm hidden transition-all">La catégorie est requise.</div>

    <label for="price" class="block">Prix (CDF) :</label>
    <input id="price" type="number" placeholder="Prix (CDF)" class="block w-full p-2 border rounded" required />
    <div id="priceError" class="text-red-500 text-sm hidden transition-all">Le prix doit être un nombre positif.</div>

    <label for="date" class="block">Date :</label>
    <input id="date" type="date" class="block w-full p-2 border rounded" required />
    <div id="dateError" class="text-red-500 text-sm hidden transition-all">La date est requise.</div>

    <label for="lieu" class="block">Lieu :</label>
    <input id="lieu" type="text" placeholder="Lieu" class="block w-full p-2 border rounded" required />
    <div id="lieuError" class="text-red-500 text-sm hidden transition-all">Le lieu est requis.</div>

    <!-- Nouveau champ pour uploader une image -->
    <label for="image" class="block">Choisir une image :</label>
    <input id="image" type="file" accept="image/*" class="block w-full p-2 border rounded" required />
    <div id="imageError" class="text-red-500 text-sm hidden transition-all">L'image est requise.</div>
    
    <img id="imagePreview" class="mt-2 max-w-full h-auto" src="" alt="Prévisualisation de l'image" style="display:none;" />
    
    <label for="description" class="block">Description :</label>
    <textarea id="description" placeholder="Description" class="block w-full p-2 border rounded" required></textarea>
    <div id="descriptionError" class="text-red-500 text-sm hidden transition-all">La description est requise.</div>
    
    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">Ajouter</button>
  </form>

  <script>
    // Prévisualisation de l'image avant soumission
    document.getElementById('image').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('imagePreview');
        preview.src = e.target.result;
        preview.style.display = 'block'; // Afficher l'image
      };
      if (file) {
        reader.readAsDataURL(file);
      }
    });

    // Validation du formulaire avant soumission
    function validateForm() {
      let isValid = true;

      // Réinitialiser les erreurs
      document.querySelectorAll('.text-red-500').forEach(error => {
        error.classList.add('hidden');
      });

      // Vérifier chaque champ
      if (!document.getElementById('title').value) {
        document.getElementById('titleError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('category').value) {
        document.getElementById('categoryError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('price').value || parseInt(document.getElementById('price').value) <= 0) {
        document.getElementById('priceError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('date').value) {
        document.getElementById('dateError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('lieu').value) {
        document.getElementById('lieuError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('image').files[0]) {
        document.getElementById('imageError').classList.remove('hidden');
        isValid = false;
      }

      if (!document.getElementById('description').value) {
        document.getElementById('descriptionError').classList.remove('hidden');
        isValid = false;
      }

      return isValid;
    }

    // Gestion du formulaire
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      const formData = new FormData();
      formData.append('title', document.getElementById('title').value);
      formData.append('category', document.getElementById('category').value);
      formData.append('price', document.getElementById('price').value);
      formData.append('date', document.getElementById('date').value);
      formData.append('lieu', document.getElementById('lieu').value);
      formData.append('image', document.getElementById('image').files[0]);
      formData.append('description', document.getElementById('description').value);

      try {
        const response = await fetch('http://localhost:3000/api/events', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erreur lors de l\'ajout de l\'événement');
        }

        const result = await response.json();
        alert(result.message);
        this.reset();
        document.getElementById('imagePreview').style.display = 'none'; // Masquer la prévisualisation
      } catch (error) {
        alert(`Erreur : ${error.message}`);
      }
    });
  </script>
</body>
</html>
