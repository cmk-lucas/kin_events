<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GÃ©nÃ©rateur de QR Code Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

  <h1 class="text-2xl md:text-3xl font-bold mb-4 text-center">ğŸ« GÃ©nÃ©rateur QR - Safari Beats</h1>
  <p class="text-sm text-gray-400 mb-6 text-center">Remplis les infos du client pour gÃ©nÃ©rer un QR Code unique</p>

  <div class="bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md">
    <div class="space-y-4">
      <div>
        <label class="block text-sm mb-1">ğŸ‘¤ Nom :</label>
        <input type="text" id="name" class="w-full p-3 rounded-lg bg-gray-700 text-white" placeholder="Nom du client">
      </div>
      <div>
        <label class="block text-sm mb-1">ğŸ“§ Email :</label>
        <input type="email" id="email" class="w-full p-3 rounded-lg bg-gray-700 text-white" placeholder="email@exemple.com">
      </div>
      <div>
        <label class="block text-sm mb-1">ğŸŸï¸ Type de Pass :</label>
        <input type="text" id="pass" class="w-full p-3 rounded-lg bg-gray-700 text-white" placeholder="Pass VIP, JournÃ©e...">
      </div>
      <div>
        <label class="block text-sm mb-1">ğŸ“ Ã‰vÃ©nement :</label>
        <input type="text" id="event" class="w-full p-3 rounded-lg bg-gray-700 text-white" placeholder="Nom de l'Ã©vÃ©nement">
      </div>
    </div>

    <button onclick="generateQR()" class="mt-6 bg-pink-600 hover:bg-pink-700 w-full py-3 rounded-lg font-bold text-lg transition">ğŸ‰ GÃ©nÃ©rer QR Code</button>

    <div id="qrcode" class="mt-8 flex justify-center"></div>

    <!-- Bouton de tÃ©lÃ©chargement -->
    <button id="downloadBtn" onclick="downloadQRCode()" class="mt-6 bg-green-600 hover:bg-green-700 w-full py-3 rounded-lg font-bold text-lg transition hidden">ğŸ“¥ TÃ©lÃ©charger QR Code</button>
  </div>

  <!-- Scanner QR -->
  <div class="mt-6 w-full max-w-md bg-gray-800 p-6 rounded-xl shadow-xl">
    <h2 class="text-xl font-semibold mb-4">ğŸ” Scanner QR Code</h2>
    <div id="reader" class="w-full h-64 border-4 border-pink-600 rounded-lg"></div>
    <div id="scanResult" class="mt-4 bg-gray-700 p-3 rounded-lg text-center text-white">ğŸ“„ En attente de scan...</div>
  </div>

  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <script>
    let qrCodeInstance;

    // Fonction de gÃ©nÃ©ration de QR Code
    function generateQR() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('pass').value.trim();
      const event = document.getElementById('event').value.trim();

      if (!name || !email || !pass || !event) {
        alert("ğŸš¨ Merci de remplir tous les champs obligatoires.");
        return;
      }

      // CrÃ©er une version plus courte du texte Ã  encoder
      const data = `${name} | ${email} | ${pass} | ${event}`;

      // VÃ©rifier si le QR Code existe dÃ©jÃ  dans le localStorage
      const existingQRCode = localStorage.getItem(data);
      if (existingQRCode) {
        alert("âŒ Ce QR Code a dÃ©jÃ  Ã©tÃ© gÃ©nÃ©rÃ© !");
        return;
      }

      // RÃ©initialiser le QR code existant
      document.getElementById('qrcode').innerHTML = "";

      // GÃ©nÃ©rer le QR code avec un niveau de correction plus bas
      qrCodeInstance = new QRCode(document.getElementById("qrcode"), {
        text: data,
        width: 220,
        height: 220,
        colorDark: "#ffffff", // QR code en blanc
        colorLight: "#1f2937", // Fond du QR code
        correctLevel: QRCode.CorrectLevel.L // Correction d'erreur faible
      });

      // Stocker les donnÃ©es dans le localStorage
      localStorage.setItem(data, JSON.stringify({ name, email, pass, event }));

      // Afficher le bouton de tÃ©lÃ©chargement
      document.getElementById('downloadBtn').classList.remove('hidden');
    }

    // Fonction de tÃ©lÃ©chargement
    function downloadQRCode() {
      // Utilisation de la mÃ©thode toDataURL pour obtenir l'image du QR code
      const canvas = document.querySelector('#qrcode canvas');
      if (canvas) {
        const dataURL = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.href = dataURL;
        link.download = "qr_code_safari_beats.png"; // Nom du fichier tÃ©lÃ©chargÃ©
        link.click(); // Simuler le clic pour tÃ©lÃ©charger
      }
    }

    // Scanner QR Code et afficher le rÃ©sultat
    const html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText, decodedResult) {
      const data = localStorage.getItem(decodedText);
      if (data) {
        const clientInfo = JSON.parse(data);
        document.getElementById('scanResult').innerText = `âœ… QR Code valide !\nNom: ${clientInfo.name}\nEmail: ${clientInfo.email}\nPass: ${clientInfo.pass}\nÃ‰vÃ©nement: ${clientInfo.event}`;
      } else {
        document.getElementById('scanResult').innerText = "âŒ QR Code non trouvÃ©.";
      }
    }

    function onScanFailure(error) {
      // Ignore error
    }

    // DÃ©marrer la camÃ©ra pour le scan
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length > 0) {
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          console.error("Erreur de dÃ©marrage de la camÃ©ra:", err);
        });
      } else {
        document.getElementById('scanResult').innerText = "âŒ Aucune camÃ©ra dÃ©tectÃ©e.";
      }
    }).catch(err => {
      document.getElementById('scanResult').innerText = `âŒ Erreur d'accÃ¨s camÃ©ra : ${err}`;
    });
  </script>

</body>
</html>
